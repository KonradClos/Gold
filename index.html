<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gold Portfolio</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">

  <style>
    body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#f7f7f7}
    .card{background:#fff;border:1px solid #e5e5e5;border-radius:14px;padding:16px;max-width:680px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1{font-size:20px;margin:0 0 12px}
    label{display:block;font-size:13px;margin-top:12px;color:#333}
    input{width:100%;padding:12px;font-size:16px;border:1px solid #d8d8d8;border-radius:10px;background:#fff}
    button{margin-top:14px;width:100%;padding:12px;font-size:16px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.6}
    .row{display:flex;justify-content:space-between;gap:12px;padding:6px 0;align-items:center}
    .out{margin-top:14px;padding:12px;background:#eef7ff;border:1px solid #cfe7ff;border-radius:10px}
    .muted{color:#666;font-size:12px;margin-top:10px}
    .err{color:#b00020;font-size:13px;margin-top:10px}
    .tag{font-size:12px;border:1px solid #ddd;border-radius:999px;padding:2px 8px;background:#fafafa}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{border:1px solid #ddd;background:#fafafa;border-radius:999px;padding:8px 12px;font-size:14px}
    .tab.active{background:#111;color:#fff;border-color:#111}
    canvas{width:100%;height:240px;background:#fff;border:1px solid #eee;border-radius:12px}
  </style>
</head>

<body>
<div class="card">
  <h1>Gold-Portfolio (Hybrid)</h1>

  <label for="ounces">Anzahl Unzen (troy oz)</label>
  <input id="ounces" inputmode="decimal" placeholder="z. B. 7 oder 12,5" />

  <button id="refresh">Aktualisieren</button>
  <div id="error" class="err"></div>

  <div class="out" id="output" style="display:none;">
    <div class="row">
      <div>Unzen (berechnet)</div>
      <div><strong id="ozUsed">–</strong></div>
    </div>
    <div class="row">
      <div>Goldpreis (Primär)</div>
      <div><strong id="pPrimary">–</strong> <span class="tag">XAUEUR</span></div>
    </div>
    <div class="row">
      <div>Goldpreis (Check)</div>
      <div><strong id="pCheck">–</strong></div>
    </div>
    <div class="row">
      <div>Portfolio-Wert</div>
      <div><strong id="portfolio">–</strong></div>
    </div>
    <div class="row">
      <div class="muted">Stand</div>
      <div class="muted" id="asOf">–</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-days="30">30 Tage</button>
    <button class="tab" data-days="90">90 Tage</button>
    <button class="tab" data-days="365">365 Tage</button>
  </div>

  <div style="margin-top:10px">
    <canvas id="chart" width="800" height="300"></canvas>
    <div class="muted" id="chartHint">Bereit.</div>
  </div>

  <div class="muted">
    Daten: Stooq (XAU/EUR). Check: XAU/USD + FX.
  </div>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);

  const btn = $("refresh");
  const err = $("error");
  const out = $("output");

  const ozUsedEl = $("ozUsed");
  const pPrimary = $("pPrimary");
  const pCheck = $("pCheck");
  const portfolioEl = $("portfolio");
  const asOfEl = $("asOf");

  const canvas = $("chart");
  const ctx = canvas.getContext("2d");
  const chartHint = $("chartHint");

  let selectedDays = 30;

  function parseNumber(v){
    if(!v) return null;
    const n = Number(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : null;
  }

  function fmtEUR(n){
    return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(n);
  }

  function proxy(url){
    return "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  }

  async function fetchCsv(url){
    const r = await fetch(proxy(url), { cache:"no-store" });
    if(!r.ok) throw new Error("Netzwerkfehler");
    return r.text();
  }

  async function fetchLast(symbol){
    const csv = await fetchCsv(`https://stooq.com/q/l/?s=${symbol}&f=sd2t2ohlc&e=csv`);
    const line = csv.trim().split("\n")[1];
    const parts = line.split(",");
    return { close: Number(parts[6]), date: parts[1], time: parts[2] };
  }

  async function refresh(){
    err.textContent = "";
    out.style.display = "none";

    const ounces = parseNumber($("ounces").value);
    if(ounces === null || ounces <= 0){
      err.textContent = "Bitte eine gültige Unzen-Zahl eingeben.";
      return;
    }

    btn.disabled = true;
    btn.textContent = "Lade…";

    try {
      const xaueur = await fetchLast("xaueur");
      const price = xaueur.close;
      const portfolio = price * ounces;

      ozUsedEl.textContent = ounces;
      pPrimary.textContent = fmtEUR(price) + " / oz";
      pCheck.textContent = "–";
      portfolioEl.textContent = fmtEUR(portfolio);
      asOfEl.textContent = `${xaueur.date} ${xaueur.time}`;

      out.style.display = "block";
      chartHint.textContent = "Chart geladen.";
    } catch(e){
      err.textContent = "Fehler beim Laden der Daten.";
    } finally {
      btn.disabled = false;
      btn.textContent = "Aktualisieren";
    }
  }

  btn.addEventListener("click", refresh);

  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      selectedDays = Number(t.dataset.days);
    });
  });
})();
</script>
</body>
</html>
