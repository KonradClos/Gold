name: Update gold data

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    paths:
      - ".github/workflows/update-gold.yml"

permissions:
  contents: write

concurrency:
  group: update-gold
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch gold prices + write price.json and history.jsonl
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data

          echo "Fetching Stooq prices…"
          curl -fLsS "https://stooq.com/q/l/?s=xaueur&f=sd2t2ohlc&e=csv" -o data/xaueur.csv
          curl -fLsS "https://stooq.com/q/l/?s=xauusd&f=sd2t2ohlc&e=csv" -o data/xauusd.csv

          echo "Fetching ECB USD/EUR…"
          curl -fLsS \
            -H "Accept: application/json" \
            -A "Mozilla/5.0 (GitHub Actions)" \
            "https://data-api.ecb.europa.eu/service/data/EXR/D.USD.EUR.SP00.A?lastNObservations=1&format=sdmx-json" \
            -o data/ecb.json

          python3 - << 'EOF'
          import csv, json, datetime, sys

          def read_latest_csv(path):
              with open(path, newline="", encoding="utf-8") as f:
                  rows = list(csv.DictReader(f))
              if not rows:
                  sys.exit(f"CSV empty: {path}")
              r = rows[-1]
              return {
                  "date": r.get("Date"),
                  "time": r.get("Time",""),
                  "close": float(r["Close"])
              }

          def read_ecb_usd_per_eur(path):
              with open(path, encoding="utf-8") as f:
                  ecb = json.load(f)
              series = ecb["dataSets"][0]["series"]
              skey = next(iter(series))
              obs = series[skey]["observations"]
              okey = next(iter(obs))
              return float(obs[okey][0])

          xaueur = read_latest_csv("data/xaueur.csv")
          xauusd = read_latest_csv("data/xauusd.csv")
          usd_per_eur = read_ecb_usd_per_eur("data/ecb.json")

          eur_primary = xaueur["close"]
          eur_check = xauusd["close"] / usd_per_eur

          asof = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

          price = {
              "asOf": asof,
              "primary": {
                  "source": "stooq-xaueur",
                  "eurPerOz": eur_primary,
                  "stooqDate": xaueur["date"],
                  "stooqTime": xaueur["time"]
              },
              "check": {
                  "source": "stooq-xauusd + ecb-usd-per-eur",
                  "eurPerOz": eur_check,
                  "usdPerEur": usd_per_eur,
                  "xauusdUsdPerOz": xauusd["close"],
                  "stooqDate": xauusd["date"],
                  "stooqTime": xauusd["time"]
              }
          }

          with open("data/price.json", "w", encoding="utf-8") as f:
              json.dump(price, f, ensure_ascii=False, indent=2)

          # --- history (JSON Lines, robust) ---
          history_line = json.dumps({
              "asOf": asof,
              "eurPerOz_primary": eur_primary,
              "eurPerOz_check": eur_check,
              "usdPerEur": usd_per_eur
          }, ensure_ascii=False)

          with open("data/history.jsonl", "a+", encoding="utf-8") as f:
              f.write(history_line + "\n")
          EOF

      - name: Commit & push
        shell: bash
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/price.json data/history.jsonl

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update gold price + history"
          git push
