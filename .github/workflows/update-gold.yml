name: Update gold data

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"
  push:
    paths:
      - ".github/workflows/update-gold.yml"

permissions:
  contents: write

concurrency:
  group: update-gold
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch gold prices and write JSON
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data

          # Fetch Stooq CSVs into data/ (clearer + avoids clutter)
          curl -fLsS "https://stooq.com/q/l/?s=xaueur&f=sd2t2ohlc&h=&e=csv" -o data/xaueur.csv
          curl -fLsS "https://stooq.com/q/l/?s=xauusd&f=sd2t2ohlc&h=&e=csv" -o data/xauusd.csv

          # ECB: USD per EUR (D.USD.EUR.SP00.A)
          curl -fLsS \
            -H "Accept: application/json" \
            -A "Mozilla/5.0 (GitHub Actions)" \
            "https://data-api.ecb.europa.eu/service/data/EXR/D.USD.EUR.SP00.A?lastNObservations=1&format=sdmx-json" \
            -o data/ecb.json

          test -s data/ecb.json || (echo "ECB response empty"; exit 1)

          python3 - << 'EOF'
          import csv, json, datetime, sys
          from pathlib import Path

          def read_stooq_latest(path: str):
              p = Path(path)
              with p.open(newline="", encoding="utf-8") as f:
                  r = csv.DictReader(f)
                  rows = list(r)

              if not rows:
                  raise SystemExit(f"Empty CSV: {path}")

              row = rows[-1]  # latest row
              # Stooq fields here usually: Date,Close (plus maybe Open/High/Low depending on f=...)
              date = row.get("Date") or row.get("date")
              close = row.get("Close") or row.get("close")

              if date is None or close is None:
                  raise SystemExit(f"Unexpected columns in {path}: {list(row.keys())}")

              # Sometimes Time exists, sometimes not
              t = row.get("Time") or row.get("time") or ""

              return {
                  "date": date,
                  "time": t,
                  "close": float(str(close).strip()),
              }

          def read_ecb_usd_per_eur(path: str) -> float:
              with open(path, encoding="utf-8") as f:
                  ecb = json.load(f)

              # SDMX-JSON typical structure:
              # dataSets[0].series[<key>].observations[<obsKey>] = [value, ...]
              try:
                  series_dict = ecb["dataSets"][0]["series"]
                  series_key = next(iter(series_dict))
                  obs_dict = series_dict[series_key]["observations"]
                  obs_key = next(iter(obs_dict))
                  value = obs_dict[obs_key][0]
                  return float(value)
              except Exception as e:
                  raise SystemExit(f"Failed to parse ECB SDMX-JSON: {e}")

          xaueur = read_stooq_latest("data/xaueur.csv")
          xauusd = read_stooq_latest("data/xauusd.csv")
          usd_per_eur = read_ecb_usd_per_eur("data/ecb.json")

          eur_per_oz_primary = xaueur["close"]
          eur_per_oz_check = xauusd["close"] / usd_per_eur

          out = {
              "asOf": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
              "primary": {
                  "source": "stooq-xaueur",
                  "eurPerOz": eur_per_oz_primary,
                  "stooqDate": xaueur["date"],
                  "stooqTime": xaueur["time"]
              },
              "check": {
                  "source": "stooq-xauusd + ecb-usd-per-eur",
                  "eurPerOz": eur_per_oz_check,
                  "usdPerEur": usd_per_eur,
                  "xauusdUsdPerOz": xauusd["close"],
                  "stooqDate": xauusd["date"],
                  "stooqTime": xauusd["time"]
              }
          }

          with open("data/price.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)
          EOF

      - name: Commit & push
        shell: bash
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/price.json
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "Update gold price data"
          git push
